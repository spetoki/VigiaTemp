rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Regra #1: Permite que a API do sensor LISTE os sensores de qualquer usuário.
    // Isso é crucial para a API encontrar o sensor pelo endereço MAC e para o
    // painel principal receber atualizações em tempo real (`onSnapshot`).
    match /users/{userId}/sensors {
      allow list, get: if true;
    }

    // Regra #2: Permite que a API do sensor ATUALIZE a temperatura
    // e ADICIONE dados ao histórico de um sensor específico.
    match /users/{userId}/sensors/{sensorId} {
      allow update: if request.resource.data.keys().hasOnly(['currentTemperature']);
      match /historicalData/{dataId} {
        allow create: if true;
      }
    }

    // Regra #3: Permite que o aplicativo web tenha acesso total
    // a QUALQUER outra coleção (alertas, lotes, etc.) dentro do
    // caminho de um usuário específico.
    match /users/{accessKey}/{document=**} {
      allow read, write: if true;
    }
  }
}
